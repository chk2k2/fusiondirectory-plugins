<?php
/*
  This code is part of FusionDirectory (http://www.fusiondirectory.org/)
  Copyright (C) 2003  Cajus Pollmeier
  Copyright (C) 2011-2019  FusionDirectory

  This program is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation; either version 2 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
*/

/* Require TOTP and dependencies */
require_once('otphp/OTPInterface.php');
require_once('otphp/TOTPInterface.php');
require_once('otphp/ParameterTrait.php');
require_once('otphp/OTP.php');
require_once('otphp/TOTP.php');
require_once('beberlei/assert/lib/Assert/AssertionFailedException.php');
require_once('beberlei/assert/lib/Assert/InvalidArgumentException.php');
require_once('beberlei/assert/lib/Assert/Assertion.php');
require_once('paragonie/constant_time_encoding/src/Binary.php');
require_once('paragonie/constant_time_encoding/src/EncoderInterface.php');
require_once('paragonie/constant_time_encoding/src/Base32.php');

class TOTPAddDialog extends GenericDialog
{
  protected $otp;
  protected $otpcode;

  function __construct ($simplePlugin, $attribute)
  {
    global $config;

    $this->attribute = $attribute;

    /* Create a TOTP object */
    $this->otp = OTPHP\TOTP::create(
      NULL,
      $config->get_cfg_value('TotpPeriod', 30),
      $config->get_cfg_value('TotpDigest', 'sha1'),
      $config->get_cfg_value('TotpDigits', 6)
    );
    $this->otp->setLabel($this->attribute->getUserUid());
    $this->otp->setIssuer(URL::getHostName());
    $this->otp->setParameter('image', URL::buildAbsoluteUrl('/geticon.php?context=applications&icon=fusiondirectory&size=48'));
  }

  function save_object ()
  {
    $this->otpcode = ($_POST['otpcode'] ?? '');
  }

  function check (): array
  {
    /* Check that code was filled and correct */
    if (empty($this->otpcode)) {
      return [_('OTP code missing')];
    } elseif (!$this->otp->verify($this->otpcode)) {
      return [_('Wrong OTP code')];
    }

    return [];
  }

  function dialog_execute ()
  {
    global $config;

    $this->save_object();

    $provisioningUri = $this->otp->getProvisioningUri();

    /* Render */
    $smarty = get_smarty();

    $smarty->assign('usePrototype', 'true');

    $smarty->assign('section',        _('Add TOTP device'));
    $smarty->assign('sectionId',      'totp');
    $smarty->assign('sectionClasses', '');
    $attributes = [];
    $attributes['otpuri'] = [
      'htmlid'        => 'otpuri',
      'label'         => '{literal}'._('QR Code').'{/literal}',
      'description'   => _('Scan this QR code and enter an OTP code below'),
      'input'         => '<img src="qrcode.php?data='.urlencode($provisioningUri).'" alt="'.$provisioningUri.'"/>',
      'subattribute'  => FALSE,
      'required'      => FALSE,
      'readable'      => TRUE,
      'writable'      => FALSE,
    ];
    $attributes['otpcode'] = [
      'htmlid'        => 'otpcode',
      'label'         => '{literal}'._('Code').'{/literal}',
      'description'   => _('After scanning the QR code, enter here the digits generated by you OTP device or application'),
      'input'         => '<input type="text" name="otpcode" id="otpcode" required="required"/>',
      'subattribute'  => FALSE,
      'required'      => TRUE,
      'readable'      => TRUE,
      'writable'      => TRUE,
    ];
    $smarty->assign('attributes', $attributes);
    $sections = [
      'totp' => $smarty->fetch(get_template_path('simpleplugin_section.tpl'))
    ];
    $smarty->assign('sections', $sections);
    $smarty->assign('hiddenPostedInput', get_class($this).'_posted');

    return $smarty->fetch(get_template_path('simpleplugin.tpl'))."\n".$this->buttons();
  }

  function buttons ()
  {
    return '<div style="width:100%; text-align:right; clear:both; float:none;">'.
           '  <input type="submit" name="'.$this->post_finish.'" value="'.msgPool::addButton().'"/>&nbsp;'.
           '  <input type="submit" formnovalidate="formnovalidate" name="'.$this->post_cancel.'" value="'.msgPool::cancelButton().'"/>'.
           '</div>';
  }

  function handle_finish ()
  {
    $this->save_object();
    $msgs = $this->check();
    if (count($msgs)) {
      msg_dialog::displayChecks($msgs);
      return $this->dialog_execute();
    }

    $this->attribute->addValue('', [date('Y-m-d'), $this->otp->getProvisioningUri()]);
    return FALSE;
  }

  function handle_cancel ()
  {
    return FALSE;
  }
}
